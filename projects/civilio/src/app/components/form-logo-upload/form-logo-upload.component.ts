import { booleanAttribute, Component, HostListener, input, InputSignal, InputSignalWithTransform, model, ModelSignal, OutputRef, signal } from '@angular/core';
import { DisabledReason, FormValueControl, ValidationError, WithOptionalField } from '@angular/forms/signals';
import { NgIcon, provideIcons } from '@ng-icons/core';
import { lucideFilePlus, lucideUpload, lucideX } from '@ng-icons/lucide';
import { HlmButton } from '@spartan-ng/helm/button';
import { random } from 'lodash';
import { hostBinding } from 'ngxtension/host-binding';

const placeholderLogosLight = [
	`<svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M20 28.4356C16.5306 28.4357 13.3035 30.2166 11.4521 33.1512L9.1543 36.7934L10.0371 37.3511C10.3132 37.5101 10.5937 37.6622 10.8779 37.8082L13.1436 34.2188C14.6285 31.8648 17.2171 30.437 20 30.4369C22.783 30.4369 25.3714 31.8647 26.8564 34.2188L29.1211 37.8082C29.4053 37.6623 29.6858 37.5101 29.9619 37.3511L30.8457 36.7934L28.5479 33.1512C26.6964 30.2165 23.4695 28.4356 20 28.4356ZM20.123 36.4428L20 36.4379C19.3855 36.4381 18.8239 36.774 18.5312 37.3072L18.4766 37.4166L17.3691 39.834C18.0662 39.9256 18.7744 39.9821 19.4922 40L20 38.8914L20.5068 40C21.2249 39.9821 21.9335 39.9256 22.6309 39.834L21.5244 37.4166L21.4697 37.3072C21.1966 36.8096 20.689 36.4842 20.123 36.4428ZM21 12.4063V0H19V12.4063L15.7891 0.422921L13.8574 0.940585L17.0674 12.923L10.8662 2.18005L9.13379 3.18021L15.335 13.9222L6.56543 5.15124L5.15039 6.56651L13.9199 15.3375L3.17969 9.13529L2.17969 10.868L12.9209 17.0702L0.94043 13.8597L0.422852 15.7917L12.4053 19.0031H0V21.0035H12.4053L0.422852 24.2149L0.94043 26.1469L12.9209 22.9354L2.17969 29.1386L3.17969 30.8713L13.9199 24.6681L5.15039 33.4401L6.56543 34.8554L13.1216 28.2964C13.684 27.7337 14 26.9706 14 26.175V20.435C14 17.1209 16.6865 14.4342 20 14.434C23.3137 14.434 26 17.1208 26 20.435V26.1759C26 26.9716 26.316 27.7347 26.8785 28.2974L33.4346 34.8554L34.8496 33.4401L26.0801 24.6691L36.8203 30.8713L37.8203 29.1386L27.0791 22.9354L39.0596 26.1469L39.5771 24.2149L27.5957 21.0035H40V19.0031H27.5947L39.5771 15.7917L39.0596 13.8597L27.0791 17.0692L37.8203 10.868L36.8203 9.13529L26.0781 15.3375L34.8496 6.56554L33.4355 5.15124L24.6641 13.9232L30.8662 3.18021L29.1338 2.18005L22.9316 12.923L26.1426 0.940585L24.2109 0.422921L21 12.4063ZM20 32.4372C18.0122 32.4374 16.1792 33.5112 15.207 35.2453L13.2021 38.8201C13.8407 39.051 14.4942 39.2501 15.1611 39.4159L16.9512 36.224C17.5694 35.1209 18.7357 34.4377 20 34.4376C21.2645 34.4376 22.4305 35.1208 23.0488 36.224L24.8379 39.4159C25.5048 39.2502 26.1583 39.0509 26.7969 38.8201L24.793 35.2453C23.8208 33.5111 21.9879 32.4372 20 32.4372Z" fill="#FF2121"></path>
</svg>`,
	`<svg width="62" height="40" viewBox="0 0 62 40" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M7.02047 20.514L38.3369 12.1305H10.0945L7.02047 20.514ZM6.59954 21.662L5.2839 25.25H5.28572L2.09656 34.1495L38.5941 13.0969L6.59954 21.662ZM1.57495 35.605L0 40H13.0334L39.094 13.9633L1.57495 35.605ZM14.4489 40H25.1661L39.8062 14.666L14.4489 40ZM26.3219 40H34.0116L40.6711 15.1693L26.3219 40ZM35.0478 40H41.6376V15.4292L35.0478 40ZM42.6385 40H49.2288L42.6385 15.4273V40ZM50.1713 39.6503L52.3203 33.6534C52.6446 32.7483 52.7601 31.7948 52.673 30.8601L43.6055 15.1691L50.1713 39.6503ZM50.386 24.9025C51.4645 24.6247 52.4867 24.1867 53.421 23.6103L44.4732 14.6707L50.386 24.9025ZM54.262 23.0363C55.1738 22.3502 55.9801 21.5219 56.6455 20.5763L45.1804 13.9629L54.262 23.0363ZM57.1836 19.732C57.492 19.1957 57.7578 18.6284 57.9758 18.0338L58.5256 16.5346L45.6778 13.0952L57.1836 19.732ZM58.8713 15.5918L60.1404 12.1305H45.9415L58.8713 15.5918ZM60.5071 11.1305L61.6315 8.06389C61.78 7.65908 61.8821 7.25179 61.9412 6.84684L45.9397 11.1305H60.5071ZM62 5.79582C61.9487 4.25961 61.2986 2.82175 60.2459 1.76246L45.6788 10.1651L62 5.79582ZM59.4324 1.07701C58.4714 0.403271 57.2938 0 55.9925 0H54.4856L45.1777 9.29939L59.4324 1.07701ZM53.0701 0H49.4371L44.4744 8.58786L53.0701 0ZM48.2814 0H45.7756L43.6056 8.09119L48.2814 0ZM44.7394 0H42.6385V7.83342L44.7394 0ZM41.6376 0H39.5372L41.6376 7.83154V0ZM38.501 0H35.9953L40.6709 8.09095L38.501 0ZM34.8396 0H31.2046L39.8051 8.59257L34.8396 0ZM29.7891 0H22.9754L39.0967 9.29905L29.7891 0ZM10.4612 11.1305H38.3387L12.953 4.33465L10.4612 11.1305ZM13.3033 3.39316L38.5932 10.1633L20.9736 0H18.3885C16.1557 0 14.1524 1.3462 13.3033 3.39316Z" fill="#FF651D"></path>
</svg>`,
	`<svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M17.343 2.65705L20 0L40 20L20 40L17.3429 37.3429L34.6859 20L17.343 2.65705Z" fill="#D41C1C"></path>
<path d="M13.8744 6.12564L16.5314 3.46859L33.0628 20L16.5314 36.5314L13.8744 33.8744L27.7487 20L13.8744 6.12564Z" fill="#D41C1C"></path>
<path d="M0 20L13.0628 6.93718L26.1256 20L13.0628 33.0628L10.4058 30.4058L20.8115 20L13.0628 12.2513L2.65705 22.657L0 20Z" fill="#D41C1C"></path>
<path d="M13.0628 13.8744L10.4058 16.5314L13.8744 20L6.93718 26.9372L9.59422 29.5942L19.1885 20L13.0628 13.8744Z" fill="#D41C1C"></path>
<path d="M6.12564 26.1256L3.46859 23.4686L9.56643 17.3708L12.2235 20.0278L6.12564 26.1256Z" fill="#D41C1C"></path>
</svg>`,
	`<svg width="51" height="40" viewBox="0 0 51 40" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M12.446 0L22.7801 8.82887C23.3936 9.35302 23.7473 10.1222 23.7473 10.9323V17.5862L13.4131 8.75734C12.7996 8.23319 12.446 7.464 12.446 6.65386V0Z" fill="#7B19D8"></path>
<path d="M12.446 40L22.7801 31.1711C23.3936 30.647 23.7473 29.8778 23.7473 29.0677V22.4138L13.4131 31.2427C12.7996 31.7668 12.446 32.536 12.446 33.3461V40Z" fill="#7B19D8"></path>
<path d="M0.117188 9.31034L10.3108 17.9705C10.805 18.3904 11.4308 18.6207 12.0775 18.6207H20.2982L10.1297 9.96253C9.63514 9.54141 9.00837 9.31034 8.36065 9.31034H0.117188Z" fill="#7B19D8"></path>
<path d="M0.117188 30.6897L10.2481 22.0345C10.7432 21.6115 11.3713 21.3793 12.0206 21.3793H20.3227L10.1291 30.0394C9.63487 30.4593 9.00904 30.6897 8.36236 30.6897H0.117188Z" fill="#7B19D8"></path>
<path d="M37.7884 0L27.4542 8.82887C26.8407 9.35302 26.4871 10.1222 26.4871 10.9323V17.5862L36.8212 8.75734C37.4347 8.23319 37.7884 7.464 37.7884 6.65386V0Z" fill="#7B19D8"></path>
<path d="M37.7884 40L27.4542 31.1711C26.8407 30.647 26.4871 29.8778 26.4871 29.0677V22.4138L36.8212 31.2427C37.4347 31.7668 37.7884 32.536 37.7884 33.3461V40Z" fill="#7B19D8"></path>
<path d="M50.1172 9.31034L39.9236 17.9705C39.4294 18.3904 38.8035 18.6207 38.1569 18.6207H29.9361L40.1047 9.96253C40.5992 9.54141 41.226 9.31034 41.8737 9.31034H50.1172Z" fill="#7B19D8"></path>
<path d="M50.1172 30.6897L39.9863 22.0345C39.4912 21.6115 38.863 21.3793 38.2137 21.3793H29.9117L40.1052 30.0394C40.5995 30.4593 41.2253 30.6897 41.872 30.6897H50.1172Z" fill="#7B19D8"></path>
</svg>`
];
const placeholderLogosDark = [
	`<svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M20 28.4356C16.5306 28.4357 13.3035 30.2166 11.4521 33.1512L9.1543 36.7934L10.0371 37.3511C10.3132 37.5101 10.5937 37.6622 10.8779 37.8082L13.1436 34.2188C14.6285 31.8648 17.2171 30.437 20 30.4369C22.783 30.4369 25.3714 31.8647 26.8564 34.2188L29.1211 37.8082C29.4053 37.6623 29.6858 37.5101 29.9619 37.3511L30.8457 36.7934L28.5479 33.1512C26.6964 30.2165 23.4695 28.4356 20 28.4356ZM20.123 36.4428L20 36.4379C19.3855 36.4381 18.8239 36.774 18.5312 37.3072L18.4766 37.4166L17.3691 39.834C18.0662 39.9256 18.7744 39.9821 19.4922 40L20 38.8914L20.5068 40C21.2249 39.9821 21.9335 39.9256 22.6309 39.834L21.5244 37.4166L21.4697 37.3072C21.1966 36.8096 20.689 36.4842 20.123 36.4428ZM21 12.4063V0H19V12.4063L15.7891 0.422921L13.8574 0.940585L17.0674 12.923L10.8662 2.18005L9.13379 3.18021L15.335 13.9222L6.56543 5.15124L5.15039 6.56651L13.9199 15.3375L3.17969 9.13529L2.17969 10.868L12.9209 17.0702L0.94043 13.8597L0.422852 15.7917L12.4053 19.0031H0V21.0035H12.4053L0.422852 24.2149L0.94043 26.1469L12.9209 22.9354L2.17969 29.1386L3.17969 30.8713L13.9199 24.6681L5.15039 33.4401L6.56543 34.8554L13.1216 28.2964C13.684 27.7337 14 26.9706 14 26.175V20.435C14 17.1209 16.6865 14.4342 20 14.434C23.3137 14.434 26 17.1208 26 20.435V26.1759C26 26.9716 26.316 27.7347 26.8785 28.2974L33.4346 34.8554L34.8496 33.4401L26.0801 24.6691L36.8203 30.8713L37.8203 29.1386L27.0791 22.9354L39.0596 26.1469L39.5771 24.2149L27.5957 21.0035H40V19.0031H27.5947L39.5771 15.7917L39.0596 13.8597L27.0791 17.0692L37.8203 10.868L36.8203 9.13529L26.0781 15.3375L34.8496 6.56554L33.4355 5.15124L24.6641 13.9232L30.8662 3.18021L29.1338 2.18005L22.9316 12.923L26.1426 0.940585L24.2109 0.422921L21 12.4063ZM20 32.4372C18.0122 32.4374 16.1792 33.5112 15.207 35.2453L13.2021 38.8201C13.8407 39.051 14.4942 39.2501 15.1611 39.4159L16.9512 36.224C17.5694 35.1209 18.7357 34.4377 20 34.4376C21.2645 34.4376 22.4305 35.1208 23.0488 36.224L24.8379 39.4159C25.5048 39.2502 26.1583 39.0509 26.7969 38.8201L24.793 35.2453C23.8208 33.5111 21.9879 32.4372 20 32.4372Z" fill="#ffffff"></path>
</svg>`,
	`<svg width="62" height="40" viewBox="0 0 62 40" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M7.02047 20.514L38.3369 12.1305H10.0945L7.02047 20.514ZM6.59954 21.662L5.2839 25.25H5.28572L2.09656 34.1495L38.5941 13.0969L6.59954 21.662ZM1.57495 35.605L0 40H13.0334L39.094 13.9633L1.57495 35.605ZM14.4489 40H25.1661L39.8062 14.666L14.4489 40ZM26.3219 40H34.0116L40.6711 15.1693L26.3219 40ZM35.0478 40H41.6376V15.4292L35.0478 40ZM42.6385 40H49.2288L42.6385 15.4273V40ZM50.1713 39.6503L52.3203 33.6534C52.6446 32.7483 52.7601 31.7948 52.673 30.8601L43.6055 15.1691L50.1713 39.6503ZM50.386 24.9025C51.4645 24.6247 52.4867 24.1867 53.421 23.6103L44.4732 14.6707L50.386 24.9025ZM54.262 23.0363C55.1738 22.3502 55.9801 21.5219 56.6455 20.5763L45.1804 13.9629L54.262 23.0363ZM57.1836 19.732C57.492 19.1957 57.7578 18.6284 57.9758 18.0338L58.5256 16.5346L45.6778 13.0952L57.1836 19.732ZM58.8713 15.5918L60.1404 12.1305H45.9415L58.8713 15.5918ZM60.5071 11.1305L61.6315 8.06389C61.78 7.65908 61.8821 7.25179 61.9412 6.84684L45.9397 11.1305H60.5071ZM62 5.79582C61.9487 4.25961 61.2986 2.82175 60.2459 1.76246L45.6788 10.1651L62 5.79582ZM59.4324 1.07701C58.4714 0.403271 57.2938 0 55.9925 0H54.4856L45.1777 9.29939L59.4324 1.07701ZM53.0701 0H49.4371L44.4744 8.58786L53.0701 0ZM48.2814 0H45.7756L43.6056 8.09119L48.2814 0ZM44.7394 0H42.6385V7.83342L44.7394 0ZM41.6376 0H39.5372L41.6376 7.83154V0ZM38.501 0H35.9953L40.6709 8.09095L38.501 0ZM34.8396 0H31.2046L39.8051 8.59257L34.8396 0ZM29.7891 0H22.9754L39.0967 9.29905L29.7891 0ZM10.4612 11.1305H38.3387L12.953 4.33465L10.4612 11.1305ZM13.3033 3.39316L38.5932 10.1633L20.9736 0H18.3885C16.1557 0 14.1524 1.3462 13.3033 3.39316Z" fill="#ffffff"></path>
</svg>`,
	`<svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M17.343 2.65705L20 0L40 20L20 40L17.3429 37.3429L34.6859 20L17.343 2.65705Z" fill="white"></path>
<path d="M13.8744 6.12564L16.5314 3.46859L33.0628 20L16.5314 36.5314L13.8744 33.8744L27.7487 20L13.8744 6.12564Z" fill="white"></path>
<path d="M0 20L13.0628 6.93718L26.1256 20L13.0628 33.0628L10.4058 30.4058L20.8115 20L13.0628 12.2513L2.65705 22.657L0 20Z" fill="white"></path>
<path d="M13.0628 13.8744L10.4058 16.5314L13.8744 20L6.93718 26.9372L9.59422 29.5942L19.1885 20L13.0628 13.8744Z" fill="white"></path>
<path d="M6.12564 26.1256L3.46859 23.4686L9.56643 17.3708L12.2235 20.0278L6.12564 26.1256Z" fill="white"></path>
</svg>`,
	`<svg width="51" height="40" viewBox="0 0 51 40" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M12.7038 0L23.038 8.82887C23.6515 9.35302 24.0051 10.1222 24.0051 10.9323V17.5862L13.671 8.75734C13.0574 8.23319 12.7038 7.464 12.7038 6.65386V0Z" fill="white"></path>
<path d="M12.7038 40L23.038 31.1711C23.6515 30.647 24.0051 29.8778 24.0051 29.0677V22.4138L13.671 31.2427C13.0574 31.7668 12.7038 32.536 12.7038 33.3461V40Z" fill="white"></path>
<path d="M0.375 9.31034L10.5686 17.9705C11.0628 18.3904 11.6887 18.6207 12.3353 18.6207H20.556L10.3875 9.96253C9.89295 9.54141 9.26618 9.31034 8.61846 9.31034H0.375Z" fill="white"></path>
<path d="M0.375 30.6897L10.5059 22.0345C11.001 21.6115 11.6292 21.3793 12.2784 21.3793H20.5805L10.3869 30.0394C9.89269 30.4593 9.26685 30.6897 8.62017 30.6897H0.375Z" fill="white"></path>
<path d="M38.0462 0L27.712 8.82887C27.0985 9.35302 26.7449 10.1222 26.7449 10.9323V17.5862L37.079 8.75734C37.6926 8.23319 38.0462 7.464 38.0462 6.65386V0Z" fill="white"></path>
<path d="M38.0462 40L27.712 31.1711C27.0985 30.647 26.7449 29.8778 26.7449 29.0677V22.4138L37.079 31.2427C37.6926 31.7668 38.0462 32.536 38.0462 33.3461V40Z" fill="white"></path>
<path d="M50.375 9.31034L40.1814 17.9705C39.6872 18.3904 39.0613 18.6207 38.4147 18.6207H30.194L40.3625 9.96253C40.8571 9.54141 41.4838 9.31034 42.1315 9.31034H50.375Z" fill="white"></path>
<path d="M50.375 30.6897L40.2441 22.0345C39.749 21.6115 39.1208 21.3793 38.4716 21.3793H30.1695L40.3631 30.0394C40.8573 30.4593 41.4831 30.6897 42.1298 30.6897H50.375Z" fill="white"></path>
</svg>`
];

@Component({
	selector: 'cv-form-logo-upload',
	viewProviders: [
		provideIcons({
			lucideFilePlus,
			lucideX,
			lucideUpload
		})
	],
	imports: [
		NgIcon,
		HlmButton
	],
	templateUrl: './form-logo-upload.component.html',
	styleUrl: './form-logo-upload.component.scss',
})
export class FormLogoUploadComponent implements FormValueControl<string | null> {
	readonly value = model<string | null>(null);
	protected readonly placeholderLogo = signal('');
	protected readonly droppingFile = hostBinding('class.hovering-file', signal(false));
	errors?: InputSignal<readonly WithOptionalField<ValidationError>[]> | InputSignalWithTransform<readonly WithOptionalField<ValidationError>[], unknown> | undefined;
	disabled?: InputSignal<boolean> | InputSignalWithTransform<boolean, unknown> | undefined;
	disabledReasons?: InputSignal<readonly WithOptionalField<DisabledReason>[]> | InputSignalWithTransform<readonly WithOptionalField<DisabledReason>[], unknown> | undefined;
	readonly = input<boolean, unknown>(false, {
		transform: booleanAttribute,
	});
	hidden?: InputSignal<boolean> | InputSignalWithTransform<boolean, unknown> | undefined;
	invalid?: InputSignal<boolean> | InputSignalWithTransform<boolean, unknown> | undefined;
	pending?: InputSignal<boolean> | InputSignalWithTransform<boolean, unknown> | undefined;
	touched?: InputSignal<boolean> | InputSignalWithTransform<boolean, unknown> | ModelSignal<boolean> | OutputRef<boolean> | undefined;
	dirty?: InputSignal<boolean> | InputSignalWithTransform<boolean, unknown> | undefined;
	name?: InputSignal<string> | InputSignalWithTransform<string, unknown> | undefined;
	required?: InputSignal<boolean> | InputSignalWithTransform<boolean, unknown> | undefined;
	min?: InputSignal<number | undefined> | InputSignalWithTransform<number | undefined, unknown> | undefined;
	minLength?: InputSignal<number | undefined> | InputSignalWithTransform<number | undefined, unknown> | undefined;
	max?: InputSignal<number | undefined> | InputSignalWithTransform<number | undefined, unknown> | undefined;
	maxLength?: InputSignal<number | undefined> | InputSignalWithTransform<number | undefined, unknown> | undefined;
	pattern?: InputSignal<readonly RegExp[]> | InputSignalWithTransform<readonly RegExp[], unknown> | undefined;

	@HostListener('window:drop', ['$event'])
	protected onWindowDrop(event: DragEvent) {
		if (this.readonly()) {
			event.preventDefault();
			return;
		}
		if (!event.dataTransfer) return;
		if ([...event.dataTransfer.items].some(i => i.kind == 'file')) {
			event.preventDefault();
		}
	}

	@HostListener('drop', ['$event'])
	protected onDrop(event: DragEvent) {
		if (this.readonly()) {
			event.preventDefault();
			return;
		}
		console.log('file dropped');
	}

	@HostListener('dragover', ['$event'])
	protected onDragOver(event: DragEvent) {
		if (this.readonly()) {
			event.preventDefault();
			return;
		}
		console.log(event);
	}

	@HostListener('dragleave')
	protected onDragLeave() {
		if (this.readonly()) {
			return;
		}
		this.droppingFile.set(false);
	}

	constructor() {
		const watcher = matchMedia('(prefers-color-scheme: dark)');
		const index = random(0, placeholderLogosLight.length - 1);
		watcher.addEventListener('change', list => {
			this.placeholderLogo.set(this.getRandomSvgPlaceholder(list.matches, index));
		});
		this.placeholderLogo.set(this.getRandomSvgPlaceholder(watcher.matches, index));
	}

	private getRandomSvgPlaceholder(useDark: boolean, index: number) {
		const svgString = useDark ? placeholderLogosDark[index] : placeholderLogosLight[index];
		const blob = new Blob([svgString as string], { type: 'image/svg+xml' });
		return URL.createObjectURL(blob);
	}

	protected onFileSelected(files: FileList | null) {
		console.log(files);
	}

}
