<div class="px-4">
	<h3 hlmH3>Choice Editor</h3>
</div>
<form class="space-y-2" (submit)="onFormSubmit($event)">
	<div
		class="px-4 sticky top-0 py-2 backdrop-blur-md border-b border-muted z-99999 flex justify-between items-center flex-wrap"
	>
		<div class="space-y-2">
			<legend hlmFieldLegend>Form choices</legend>
			<p hlmFieldDescription>Add or edit choices for the form</p>
		</div>
		<div class="flex items-center gap-2">
			<!-- <div hlmInputGroup>
				<input
					[disabled]="formData().groups.length == 0"
					type="search"
					hlmInputGroupInput
					placeholder="Filter..."
				/>
				<div hlmInputGroupAddon>
					<ng-icon name="lucideFilter" />
				</div>
			</div> -->
			@if(formModel().dirty()) {
			<button
				[disabled]="formModel().invalid() || savingChanges()"
				type="submit"
				hlmBtn
			>
				<ng-icon
					[class.animate-spin]="savingChanges()"
					[name]="savingChanges() ? 'lucideLoader' : 'lucideSaveAll'"
				/>
				<span>
					@if(savingChanges()) { Saving changes... } @else { Save changes }
				</span>
			</button>
			}
			<button
				(click)="onAddGroupButtonClicked()"
				type="button"
				hlmBtn
				[disabled]="savingChanges()"
				variant="secondary"
			>
				<ng-icon name="lucidePlus" />
				<span>Add Group</span>
			</button>
		</div>
	</div>
	<div hlmFieldGroup>
		@for (group of formModel.groups; track $index; let lineIndex = $index) {
		<div class="px-4 group grid grid-cols-[1fr_auto] items-start">
			<div>
				<div class="lg:max-w-3/4">
					<div hlmFieldGroup>
						<div hlmFieldGroup class="flex gap-2">
							<div class="grid gap-x-3 grid-cols-2 items-end">
								<div hlmField>
									<div hlmFieldContent>
										<label hlmFieldLabel for="group__{{lineIndex}}__group_input"
											>Group Title <span class="text-red-500">*</span></label
										>
										<input
											hlmInput
											[field]="$any(group.data.title)"
											id="group__{{lineIndex}}__group_input"
										/>
										<ng-container
											[ngTemplateOutlet]="errorsTemplate"
											[ngTemplateOutletContext]="{ $implicit: group.data.title() }"
										/>
									</div>
								</div>
								<div hlmField>
									<div hlmFieldContent>
										<div class="flex justify-between items-end">
											<label
												hlmFieldLabel
												for="group__{{lineIndex}}__group_key_input"
											>
												Group Key <span class="text-red-500">*</span>
											</label>
											<button
												(click)="generateGroupKeyAt(lineIndex)"
												type="button"
												hlmBtn
												size="icon-sm"
												title="Generate"
												variant="ghost"
											>
												<ng-icon name="lucideRefreshCw" />
											</button>
										</div>
										<input
											hlmInput
											[field]="$any(group.data.key)"
											id="group__{{lineIndex}}__group_key_input"
										/>
										<ng-container
											[ngTemplateOutlet]="errorsTemplate"
											[ngTemplateOutletContext]="{$implicit: group.data.key()}"
										/>
									</div>
								</div>
							</div>
							<div class="grid grid-cols-[200px_1fr] gap-x-3">
								<div hlmField>
									<label
										hlmFieldLabel
										for="group__{{lineIndex}}__group_parent_key_input"
									>
										Parent
									</label>
									<div hlmFieldContent class="flex gap-x-2">
										<brn-popover sideOffset="5" class="w-full">
											<button
												type="button"
												hlmBtn
												brnPopoverTrigger
												id="group__{{lineIndex}}__group_parent_key_input"
												variant="outline"
												class="flex justify-between w-[200px]"
											>
												<span>Select parent group</span>
												<ng-icon name="lucideChevronsUpDown" />
											</button>
											<hlm-command
												*brnPopoverContent="let ctx"
												hlmPopoverContent
												class="p-0 w-[200px]"
											>
												<hlm-command-search class="w-full!">
													<ng-icon name="lucideSearch" />
													<input
														type="search"
														placeholder="Search parent group..."
														hlm-command-search-input
													/>
												</hlm-command-search>
												<div *hlmCommandEmptyState hlmCommandEmpty>
													No results found.
												</div>
												<hlm-command-list>
													<hlm-command-group>
														@for(g of formData().groups; track g) {
														<ng-container>
															@if(!g.isNew && g.data.key !=
															group().value().data.parentKey) {
															<button
																(selected)="onSetParentKey($any(g.data.key), lineIndex)"
																hlm-command-item
																[value]="$any(g.data.key)"
															>
																<span class="line-clamp-1 text-ellipsis"
																	>{{ g.data.title }}</span
																>
															</button>
															}
														</ng-container>
														}
													</hlm-command-group>
												</hlm-command-list>
											</hlm-command>
										</brn-popover>
										<ng-container
											[ngTemplateOutlet]="errorsTemplate"
											[ngTemplateOutletContext]="{ $implicit: group.data.parentKey() }"
										/>
									</div>
								</div>
								<div hlmField>
									<label
										hlmFieldLabel
										for="group__{{lineIndex}}__group_parent_value_input"
									>
										Parent value
									</label>
									@let parent = parents()[lineIndex];
									<div hlmFieldContent>
										<hlm-select
											[disabled]="!parent"
											placeholder="Select value"
											class="w-full"
										>
											<hlm-select-trigger class="w-full">
												<hlm-select-value />
											</hlm-select-trigger>
											<hlm-select-content>
												@if(parent) {
												<ng-container>
													@for(option of parent.options; track option) {
													<hlm-option
														[value]="option.value"
														class="line-clamp-1 text-ellipsis"
														>{{ option.label }}</hlm-option
													>
													}
												</ng-container>
												}
											</hlm-select-content>
										</hlm-select>
										<ng-container
											[ngTemplateOutlet]="errorsTemplate"
											[ngTemplateOutletContext]="{ $implicit: group.data.parentValue() }"
										/>
									</div>
								</div>
							</div>
						</div>
						<div hlmField>
							<div hlmFieldContent>
								<label
									hlmFieldLabel
									for="group__{{lineIndex}}__description_input"
									>Description</label
								>
								<textarea
									hlmTextarea
									rows="5"
									[field]="$any(group.data.description)"
								></textarea>
							</div>
						</div>
					</div>
					@let expanded = group.expanded().value();
					<div
						#expansionPanel
						(dblclick)="onToggleExpanded($event, $index)"
						[ngClass]="{
		'flex justify-between transition-all items-center mt-3 py-3 px-2 rounded-md border cursor-pointer': true,
		'border-t border-x border-border rounded-b-none border-b-0': expanded
	}"
					>
						<div class="flex gap-3 items-baseline">
							<label hlmLabel
								>{{ group.data.options().value().length }} Options</label
							>
							<ng-container
								[ngTemplateOutlet]="errorsTemplate"
								[ngTemplateOutletContext]="{ $implicit: group.data.options() }"
							/>
						</div>
						<div class="flex gap-3 items-baseline">
							@if(expanded) {
							<button
								hlmBtn
								type="button"
								variant="outline"
								size="icon-sm"
								(click)="onAddOptionButtonClicked($index)"
							>
								<ng-icon name="lucidePlus" />
							</button>
							@let isSequential = optionsSequential()[$index];
							<p
								[ngClass]="{
					'text-green-500 dark:text-green-600': isSequential,
					'text-muted-foreground': !isSequential,
				}"
								class="text-xs font-medium flex items-center gap-3"
							>
								<span>Sequence: {{ isSequential ? "ON" : "OFF" }}</span>
							</p>
							}
							<button
								(click)="onToggleExpanded($event, $index)"
								hlmBtn
								type="button"
								[variant]="expanded ? 'secondary' : 'ghost'"
								size="icon-sm"
							>
								<ng-icon
									[name]="!expanded ? 'lucideChevronDown' : 'lucideChevronUp'"
								/>
							</button>
						</div>
					</div>
					@if(expanded) {
					<ng-container> @let newItems = newOptions()[$index];</ng-container>
					<div
						hlmFieldGroup
						animate.enter="expand"
						animate.leave="shrink"
						[class.pt-2]="newItems.length == 0"
						class="relative text-(--secondary-foreground) pb-2 border-border border rounded-b-md bg-(--secondary)/50 max-h-[500px] overflow-y-auto scrollbar-thin scrollbar-thumb-primary/50 scrollbar-track-transparent"
					>
						@if(newItems.length > 0) {
						<div
							class="py2 sticky top-0 z-9999 backdrop-blur-md border-b border-border shadow-md"
						>
							<div hlmFieldGroup class="overflow-y-hidden max-h-[400px]">
								<fieldset hlmFieldSet>
									<legend hlmFieldLegend class="px-2 pt-2">New Options</legend>
									<p hlmFieldDescription class="px-2">
										The options you add here will be appended to the end of the
										list of existing options
									</p>
									<div
										hlmFieldGroup
										cdkDropList
										(cdkDropListDropped)="onNewItemReOrdered($event, lineIndex)"
										class="items max-h-[250px] overflow-y-auto scrollbar-thin scrollbar-thumb-primary/50 scrollbar-track-transparent"
									>
										@for(option of group.data.options; track option) {
										<ng-container>
											@if($index >= newItemsIndexOffset()[lineIndex]) {
											<div
												[ngClass]="{
												'border-b border-border': !$last,
											}"
												class="item px-2"
												cdkDrag
												cdkDragLockAxis="y"
											>
												<div class="drag-placeholder" *cdkDragPlaceholder></div>
												<div
													hlmFieldGroup
													class="items-end grid gap-x-2 group"
													[ngClass]="{
											'grid-cols-[auto_minmax(auto,1fr)_1fr_1fr_auto]': !!parents()[lineIndex],
											'grid-cols-[auto_minmax(auto,1fr)_1fr_auto]': !parents()[lineIndex]
										}"
												>
													<div
														cdkDragHandle
														class="cursor-grab active:cursor-grabbing text-muted-foreground p-2 size-10 flex items-center justify-center rounded-md border-border"
													>
														<ng-icon name="lucideMenu" />
													</div>
													<ng-container
														[ngTemplateOutlet]="optionRowTemplate"
														[ngTemplateOutletContext]="{
													$implicit: option,
													index: $index,
													last: $last,
													unifiedIndex: $index,
													line: lineIndex
												}"
													/>
												</div>
											</div>
											}
										</ng-container>
										}
									</div>
								</fieldset>
							</div>
						</div>
						}
						<div
							class="items"
							cdkDropList
							(cdkDropListDropped)="onItemReordered($event, lineIndex)"
						>
							@for(option of group.data.options; track option) {
							<ng-container>
								@if($index < newItemsIndexOffset()[lineIndex]) {
								<div
									[ngClass]="{
							'border-b border-border': true,
						}"
									class="item px-2"
									cdkDrag
									cdkDragLockAxis="y"
								>
									<div class="drag-placeholder" *cdkDragPlaceholder></div>
									<div
										hlmFieldGroup
										class="px-2 items-end grid gap-x-2 group"
										[ngClass]="{
											'grid-cols-[auto_minmax(auto,1fr)_1fr_1fr_auto]': !!parents()[lineIndex],
											'grid-cols-[auto_minmax(auto,1fr)_1fr_auto]': !parents()[lineIndex]
										}"
									>
										<div
											cdkDragHandle
											class="font-extrabold cursor-grab active:cursor-grabbing text-muted-foreground p-2 size-10 flex items-center justify-center rounded-md border border-border"
										>
											<ng-icon name="lucideMenu" />
										</div>
										<ng-container
											[ngTemplateOutlet]="optionRowTemplate"
											[ngTemplateOutletContext]="{
									$implicit: option,
									index: $index,
									last: $last,
									unifiedIndex: $index,
									line: lineIndex
								}"
										/>
									</div>
								</div>
								}
							</ng-container>
							}
						</div>
					</div>
					}
				</div>
			</div>
			<div class="flex items-center gap-2">
				<button
					type="button"
					hlmBtn
					[disabled]="savingChanges()"
					variant="destructive"
					size="icon-sm"
					(click)="onDeleteLineButtonClicked(lineIndex)"
					class=""
				>
					<ng-icon name="lucideTrash2" />
				</button>
			</div>
		</div>
		<ng-container>
			@if (!$last) {
			<hlm-field-separator />
			}
		</ng-container>
		}
	</div>
</form>

<ng-template
	#optionRowTemplate
	let-fieldSignal
	let-index="index"
	let-unifiedIndex="unifiedIndex"
	let-line="line"
>
	<div hlmField>
		<label hlmFieldLabel for="{{line}}__label_input_{{unifiedIndex}}">
			Label <span class="text-red-500">*</span>
		</label>
		<div hlmFieldContent>
			<input hlmInput [field]="fieldSignal.label" />
			<ng-container
				[ngTemplateOutlet]="errorsTemplate"
				[ngTemplateOutletContext]="{ $implicit: fieldSignal.label() }"
			/>
		</div>
	</div>
	<div hlmField>
		<label hlmFieldLabel for="{{line}}__value_input_{{unifiedIndex}}">
			Value <span class="text-red-500">*</span>
		</label>
		<div hlmFieldContent>
			<input hlmInput [field]="fieldSignal.value" />
			<ng-container
				[ngTemplateOutlet]="errorsTemplate"
				[ngTemplateOutletContext]="{ $implicit: fieldSignal.value() }"
			/>
		</div>
	</div>
	@if(parents()[line]) {
	<div hlmField>
		<label hlmFieldLabel for="{{line}}__parent_input_{{unifiedIndex}}">
			Parent value
		</label>
		<div hlmFieldContent>
			<!-- <input hlmInput [field]="fieldSignal.parentValue" /> -->
			<brn-popover>
				<button
					class="flex w-full justify-between"
					type="button"
					hlmBtn
					brnPopoverTrigger
					variant="outline"
				>
					<span class="text-muted-foreground">Select parent</span>
					<ng-icon name="lucideChevronsUpDown" class="opacity-50" />
				</button>
				<hlm-command
					*brnPopoverContent="let ctx"
					hlmPopoverContent
					class="w-[200px] p-0"
				>
					<hlm-command-search>
						<ng-icon name="lucideSearch" />
						<input placeholder="Choose " hlm-command-search-input />
					</hlm-command-search>
					<div *hlmCommandEmptyState hlmCommandEmpty>No Results</div>
					<!-- <hlm-command-list -->
				</hlm-command>
			</brn-popover>
			<ng-container
				[ngTemplateOutlet]="errorsTemplate"
				[ngTemplateOutletContext]="{ $implicit: fieldSignal.parentValue() }"
			/>
		</div>
	</div>
	}
	<button
		type="button"
		class="group-hover:pointer-events-auto group-hover:opacity-100 pointer-events-none opacity-0"
		type="button"
		size="icon-sm"
		hlmBtn
		variant="outline"
	>
		<ng-icon name="lucideTrash2" />
	</button>
</ng-template>

<ng-template #errorsTemplate let-field>
	@if (field.pending()) {
	<div hlmFieldDescription class="flex items-baseline gap-1">
		<ng-icon name="lucideLoader" class="animate-spin" />
		<span>Checking availability...</span>
	</div>
	} @else if (field.invalid() && field.touched()) {
	<div class="space-y-1">
		@for (error of field.errors(); track error) {
		<hlm-field-error> {{ error.message }} </hlm-field-error>
		}
	</div>
	}
</ng-template>
