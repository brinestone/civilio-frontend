<div class="px-4">
	<h3 hlmH3>{{ 'settings.dataset.title' | translate }}</h3>
</div>
<form
	[formGroup]="form"
	(ngSubmit)="onFormSubmit()"
	(reset)="onFormReset($event)"
>
	<div
		class="px-4 sticky top-0 py-2 backdrop-blur border-b border-muted z-99999 flex justify-between items-center flex-wrap"
	>
		<div class="space-y-2">
			<!-- <legend hlmFieldLegend>Datasets</legend> -->
			<p hlmFieldDescription>
				{{ 'settings.dataset.form.description' | translate }}
			</p>
		</div>
		<div class="flex items-center gap-2">
			@if (form.dirty) {
			<button [disabled]="form.invalid || savingChanges()" hlmBtn type="submit">
				<ng-icon
					[class.animate-spin]="savingChanges()"
					[name]="savingChanges() ? 'lucideLoader' : 'lucideSaveAll'"
				/>
				<span>
					@if (savingChanges()) { {{ 'misc.actions.saving_changes' | translate
					}}... } @else { {{ 'misc.actions.save' | translate }} }
				</span>
			</button>
			<button
				[disabled]="savingChanges()"
				hlmBtn
				type="reset"
				variant="destructive"
			>
				<ng-icon name="lucideX" />
				<span>{{ 'misc.actions.discard' | translate }}</span>
			</button>
			}
			<button
				(click)="onAddGroupButtonClicked()"
				type="button"
				hlmBtn
				[disabled]="savingChanges()"
				variant="secondary"
			>
				<ng-icon name="lucidePlus" />
				<div class="inline-flex gap-2">
					<span
						>{{ 'settings.dataset.form.actions.add_new.title' | translate
						}}</span
					>
					<kbd hlmKbdGroup>
						<kbd hlmKbd> @if (isMac) { âŒ˜ } @else { Ctrl } + =</kbd>
					</kbd>
				</div>
			</button>
		</div>
	</div>
	<div hlmFieldGroup formArrayName="datasets" class="pt-2">
		@for (groupCtrl of form.controls.datasets.controls; track
		groupCtrl.value.meta!.trackingKey; let lineIndex = $index) {
		<div
			class="px-4 group/line grid lg:grid-cols-[75%_auto] grid-cols-[1fr_auto] items-start"
		>
			<div formGroupName="{{$index}}">
				<div formGroupName="data" hlmFieldGroup>
					<div class="flex gap-2" hlmFieldGroup>
						<div class="grid gap-x-3 grid-cols-2 items-end">
							<div hlmField>
								<div hlmFieldContent>
									<label for="group__{{lineIndex}}__title_input" hlmFieldLabel
										>{{ 'settings.dataset.form.fields.group_title.title' |
										translate }} <span class="text-red-500">*</span></label
									>
									<input
										formControlName="title"
										hlmInput
										id="group__{{lineIndex}}__title_input"
									/>
									@if (groupCtrl.controls.data.controls.title.invalid &&
									groupCtrl.controls.data.controls.title.touched) {
									<ng-container
										[ngTemplateOutletContext]="{$implicit:  groupCtrl.controls.data.controls.title}"
										[ngTemplateOutlet]="errorsTemplate"
									/>
									} @else {
									<p class="line-clamp-1 text-ellipsis" hlmFieldDescription>
										{{ 'settings.dataset.form.fields.group_title.description' |
										translate }}
									</p>
									}
								</div>
							</div>
							<div hlmField>
								<div hlmFieldContent>
									<div class="flex justify-between items-end">
										<label for="group__{{lineIndex}}__key_input" hlmFieldLabel>
											<span
												>{{ 'settings.dataset.form.fields.key.title' | translate
												}}</span
											>
											<span class="text-red-500">*</span>
										</label>
										<button
											(click)="generateGroupKeyAt(lineIndex)"
											hlmBtn
											size="icon-sm"
											tabindex="-1"
											title="{{ 'settings.dataset.form.fields.key.actions.generate' | translate}}"
											type="button"
											variant="ghost"
										>
											<ng-icon name="lucideRefreshCw" />
										</button>
									</div>
									<input
										formControlName="key"
										hlmInput
										id="group__{{lineIndex}}__key_input"
									/>
									<ng-container>
										@let keyCtrl = groupCtrl.controls.data.controls.key;
									</ng-container>
									@if ((keyCtrl.invalid && keyCtrl.touched) || keyCtrl.pending)
									{
									<ng-container
										[ngTemplateOutletContext]="{$implicit:  groupCtrl.controls.data.controls.key}"
										[ngTemplateOutlet]="errorsTemplate"
									/>
									} @else {
									<p class="line-clamp-1 text-ellipsis" hlmFieldDescription>
										{{ 'settings.dataset.form.fields.key.description' |
										translate }}
									</p>
									}
								</div>
							</div>
						</div>
						<ng-container> @let parent = parents()[lineIndex]; </ng-container>
						@if (hasExistingGroups() && (availableParents()[lineIndex]?.length
						?? 0) > 0) {
						<div hlmField>
							<div hlmFieldContent>
								<label
									for="group__{{lineIndex}}__parent_group_select"
									hlmFieldLabel
									>{{ 'settings.dataset.form.fields.parent.title' | translate
									}}</label
								>
								<hlm-select
									class="w-full"
									formControlName="parentId"
									id="group__{{lineIndex}}__parent_group_select"
									placeholder="Select parent group"
								>
									<hlm-select-trigger class="w-full">
										<hlm-select-value>
											<span>{{ parent?.data?.title }}</span>
										</hlm-select-value>
									</hlm-select-trigger>
									<hlm-select-content>
										<hlm-option [value]="null"
											>{{ 'misc.none' | translate }}
										</hlm-option>
										@for (g of availableParents()[lineIndex]; track g.data!.id)
										{
										<ng-container>
											<hlm-option [value]="g.data!.id" class="cursor-pointer">
												<span class="line-clamp-1 text-ellipsis">
													{{ g.data!.title }}
												</span>
											</hlm-option>
										</ng-container>
										}
									</hlm-select-content>
								</hlm-select>
								<p class="line-clamp-2 text-ellipsis" hlmFieldDescription>
									{{ 'settings.dataset.form.fields.parent.description' |
									translate }}
								</p>
							</div>
						</div>
						}
					</div>
					<div hlmField>
						<div hlmFieldContent>
							<label for="group__{{lineIndex}}__description_input" hlmFieldLabel
								>{{ 'settings.dataset.form.fields.description.title' | translate
								}}</label
							>
							<textarea
								formControlName="description"
								hlmTextarea
								rows="5"
							></textarea>
						</div>
					</div>
				</div>
				@let expanded = groupCtrl.value.meta?.expanded;
				<div
					#expansionPanel
					(dblclick)="onToggleExpanded($event, lineIndex)"
					[ngClass]="{
						'flex justify-between transition-all items-center mt-3 py-3 px-2 rounded-md border cursor-pointer': true,
						'borer-t borer-x border-border rounded-b-none border-b-0': expanded === true
					}"
				>
					<div class="flex gap-3 items-baseline">
						@let optionLength =
						groupCtrl.controls.data.controls.items.controls.length;
						<label class="block" hlmLabel
							>{{ optionLength }} {{ 'settings.dataset.form.fields.items.title'
							| translate }}{{ optionLength != 1 ? 's' : '' }}</label
						>
						<ng-container
							[ngTemplateOutletContext]="{
							$implicit: groupCtrl.controls.data.controls.items
						}"
							[ngTemplateOutlet]="errorsTemplate"
						/>
					</div>
					<div class="flex gap-3 items-baseline">
						@if (expanded) {
						<button
							(click)="onAddItemButtonClicked(lineIndex)"
							hlmBtn
							size="icon-sm"
							type="button"
							variant="outline"
						>
							<ng-icon name="lucidePlus" />
						</button>
						@let isSequential = itemsSequential()[lineIndex];
						<p
							[ngClass]="{
								'text-green-500 dark:text-green-600': isSequential,
								'text-muted-foreground': !isSequential
							}"
							class="text-xs font-medium flex items-center gap-3"
						>
							<span class="capitalize"
								>{{ 'misc.sequence' | translate }}: {{ (isSequential ?
								'misc.active' : 'misc.inactive') | translate }}</span
							>
						</p>
						}
						<button
							(click)="onToggleExpanded($event, lineIndex)"
							[variant]="expanded ? 'secondary' : 'ghost'"
							hlmBtn
							size="icon-sm"
							type="button"
						>
							<ng-icon
								[name]="!expanded ? 'lucideChevronDown' : 'lucideChevronUp'"
							/>
						</button>
					</div>
				</div>
				@if (expanded) {
				<ng-container> @let newItems = newOptions()[lineIndex]; </ng-container>
				<div
					[class.pt-2]="newItems.length == 0"
					animate.enter="expand"
					animate.leave="shrink"
					class="relative text-(--secondary-foreground) pb-2 border-border border rounded-b-md bg-(--secondary)/50 max-h-87.5! overflow-y-auto scrollbar-thin scrollbar-thumb-primary/50 scrollbar-track-transparent"
					formGroupName="data"
					hlmFieldGroup
				>
					@if (newItems.length > 0) {
					<div
						class="py-2 sticky top-0 z-9999 backdrop-blur-md border-b border-border shadow-md"
					>
						<div class="overflow-y-hidden max-h-87.5" hlmFieldGroup>
							<fieldset hlmFieldSet>
								<legend class="px-2 pt-2" hlmFieldLegend>
									{{ 'settings.dataset.form.fields.items.new_item.title' |
									translate }}
								</legend>
								<p class="px-2" hlmFieldDescription>
									{{ 'settings.dataset.form.fields.items.new_item.description' |
									translate }}
								</p>
								<div
									(cdkDropListDropped)="onNewItemReordered($event, lineIndex)"
									cdkDropList
									class="items max-h-62.5 overflow-y-auto scrollbar-thin scrollbar-thumb-primary/50 scrollbar-track-transparent"
									formArrayName="items"
									hlmFieldGroup
								>
									@for (itemValue of newOptions()[lineIndex]; track
									itemValue.trackingKey) {
									<ng-container formGroupName="{{$index}}">
										<div
											cdkDrag
											cdkDragLockAxis="y"
											class="item px-2 group/item border-border border-b"
										>
											<div *cdkDragPlaceholder class="drag-placeholder"></div>
											<div
												[ngClass]="{
												'grid-cols-[auto_minmax(auto,1fr)_1fr_1fr_auto]': !!parents()[lineIndex],
												'grid-cols-[auto_minmax(auto,1fr)_1fr_auto]': !parents()[lineIndex]
											}"
												class="items-start grid gap-x-2"
												hlmFieldGroup
											>
												<div class="flex items-center justify-center self-end">
													<div
														cdkDragHandle
														class="cursor-grab active:cursor-grabbing text-muted-foreground p-2 size-10 flex items-center justify-center rounded-md border-border"
													>
														<ng-icon name="lucideMenu" />
													</div>
												</div>
												<ng-container
													[ngTemplateOutletContext]="{
															$implicit: form.controls.datasets.at(lineIndex).controls.data.controls.items.controls.at($index + newItemsIndexOffset()[lineIndex]),
															index: $index,
															last: $last,
															unifiedIndex: $index + newItemsIndexOffset()[lineIndex],
															line: lineIndex
														}"
													[ngTemplateOutlet]="optionRowTemplate"
												/>
											</div>
										</div>
									</ng-container>
									}
								</div>
							</fieldset>
						</div>
					</div>
					}
					<div
						(cdkDropListDropped)="onItemReordered($event, lineIndex)"
						cdkDropList
						class="items"
						formArrayName="items"
					>
						@for (itemCtrl of groupCtrl.controls.data.controls.items.controls;
						track itemCtrl.value!.trackingKey) {
						<ng-container>
							@if ($index < newItemsIndexOffset()[lineIndex]) {
							<div
								[ngClass]="{
										'border-b border-border': true
									}"
								cdkDrag
								cdkDragLockAxis="y"
								class="px-2 item group/item"
							>
								<div *cdkDragPlaceholder class="drag-placeholder"></div>
								<div
									[ngClass]="{
										'grid-cols-[auto_minmax(auto,1fr)_1fr_1fr_auto]': !!parents()[lineIndex],
										'grid-cols-[auto_minmax(auto,1fr)_1fr_auto]': !parents()[lineIndex]
									}"
									class="px-2 items-end grid gap-x-2"
									hlmFieldGroup
								>
									<div class="flex items-center justify-center self-end">
										<div
											cdkDragHandle
											class="font-extrabold cursor-grab active:cursor-grabbing text-muted-foreground p-2 size-10 flex items-center justify-center rounded-md border border-border"
										>
											<ng-icon name="lucideMenu" />
										</div>
									</div>
									<ng-container
										[ngTemplateOutletContext]="{
										$implicit: itemCtrl,
										index: $index,
										last: $last,
										unifiedIndex: $index,
										line: lineIndex
									}"
										[ngTemplateOutlet]="optionRowTemplate"
									/>
								</div>
							</div>
							}
						</ng-container>
						}
					</div>
				</div>
				}
			</div>
			<div
				class="pt-2 flex justify-end flex-wrap gap-2 opacity-0 group-hover/line:opacity-100 transition-opacity"
			>
				<button
					(click)="onDeleteLineButtonClicked(lineIndex)"
					hlmBtn
					type="button"
					variant="destructive"
				>
					<ng-icon name="lucideTrash2" />
				</button>
			</div>
		</div>
		<ng-container>
			@if (!$last) {
			<hlm-separator />
			}
		</ng-container>
		}
	</div>
</form>

<hlm-alert-dialog [state]="pendingChangesDialogState()" #pendingChangesDialog>
	<hlm-alert-dialog-content *hlmAlertDialogPortal="let ctx" class="min-w-125!">
		<hlm-alert-dialog-header>
			<h2 hlmAlertDialogTitle>
				{{ 'misc.dialogs.pending_changes.title' | translate }}
			</h2>
			<p hlmAlertDialogDescription>
				{{ 'misc.dialogs.pending_changes.description1' | translate }}
				<strong
					>{{ 'misc.dialogs.pending_changes.description2' | translate }}</strong
				>. {{ 'misc.dialogs.pending_changes.description3' | translate }}
			</p>
		</hlm-alert-dialog-header>
		<hlm-alert-dialog-footer>
			<button
				type="button"
				(click)="pendingChangesCallback?.({action: 'close', callback: ctx.close})"
				hlmAlertDialogCancel
				class="cursor-pointer"
			>
				<ng-icon name="lucideX" />
				<span>{{ 'misc.actions.stay_here' | translate }}</span>
			</button>
			<button
				type="button"
				(click)="pendingChangesCallback?.({action: 'save', callback: ctx.close})"
				hlmAlertDialogAction
				variant="default"
				class="cursor-pointer"
			>
				<ng-icon name="lucideSave" />
				<span>{{ 'misc.actions.save_and_leave' | translate }}</span>
			</button>
			<button
				type="button"
				hlmAlertDialogCancel
				variant="destructive"
				(click)="pendingChangesCallback?.({action: 'leave', callback: ctx.close})"
				class="cursor-pointer"
			>
				<ng-icon name="lucideTrash2" />
				<span>{{ 'misc.actions.discard' | translate }}</span>
			</button>
		</hlm-alert-dialog-footer>
	</hlm-alert-dialog-content>
</hlm-alert-dialog>

<hlm-alert-dialog [state]="lineDeletionDialogState()" #lineDeletionConfirmation>
	<hlm-alert-dialog-content *hlmAlertDialogPortal="let ctx">
		<hlm-alert-dialog-header>
			<h2 hlmAlertDialogTitle>
				{{ 'settings.dataset.form.dialogs.group_deletion.title' | translate }}
			</h2>
			<p hlmAlertDialogDescription>
				{{ 'settings.dataset.form.dialogs.group_deletion.description1' |
				translate }}.
				<strong
					>{{ 'settings.dataset.form.dialogs.group_deletion.description2' |
					translate }}</strong
				>. {{ 'settings.dataset.form.dialogs.group_deletion.description3' |
				translate }}
			</p>
		</hlm-alert-dialog-header>
		<hlm-alert-dialog-footer>
			<button
				(click)="ctx.close();lineDeletionConfirmationCallback = undefined;lineDeletionDialogState.set('closed')"
				hlmAlertDialogAction
				class="cursor-pointer"
				type="button"
			>
				{{ 'settings.dataset.form.dialogs.group_deletion.actions.cancel' |
				translate }}
			</button>
			<button
				(click)="lineDeletionConfirmationCallback?.(ctx.close)"
				hlmAlertDialogCancel
				class="cursor-pointer"
				type="button"
			>
				{{ 'settings.dataset.form.dialogs.group_deletion.actions.proceed' |
				translate }}
			</button>
		</hlm-alert-dialog-footer>
	</hlm-alert-dialog-content>
</hlm-alert-dialog>

<ng-template
	#optionRowTemplate
	let-fg
	let-index="index"
	let-unifiedIndex="unifiedIndex"
	let-line="line"
>
	<ng-container [formGroup]="fg">
		<div hlmField>
			<label hlmFieldLabel for="{{line}}__label_input_{{unifiedIndex}}">
				{{ 'settings.dataset.form.fields.items.fields.label.title' | translate
				}}
				<span class="text-red-500">*</span>
			</label>
			<div hlmFieldContent>
				<input formControlName="label" hlmInput />
				<ng-container
					[ngTemplateOutlet]="errorsTemplate"
					[ngTemplateOutletContext]="{ $implicit: fg.controls.label }"
				/>
			</div>
		</div>
		<div hlmField>
			<label hlmFieldLabel for="{{line}}__value_input_{{unifiedIndex}}">
				{{ 'settings.dataset.form.fields.items.fields.value.title' | translate
				}}
				<span class="text-red-500">*</span>
			</label>
			<div hlmFieldContent>
				<input formControlName="value" hlmInput />
				<ng-container
					[ngTemplateOutlet]="errorsTemplate"
					[ngTemplateOutletContext]="{ $implicit: fg.controls.value }"
				/>
			</div>
		</div>
		<ng-container> @let parent = parents()[line]; </ng-container>
		@if (parent) {
		<div hlmField>
			<label for="{{line}}__parent_input_{{unifiedIndex}}" hlmFieldLabel>
				{{ 'settings.dataset.form.fields.items.fields.parent_value.title' |
				translate }}
			</label>
			<div hlmFieldContent>
				<hlm-select
					class="w-full"
					formControlName="parentValue"
					id="{{line}}__parent_input_{{unifiedIndex}}"
				>
					<hlm-select-trigger class="w-full">
						<hlm-select-value />
					</hlm-select-trigger>
					<hlm-select-content class="w-full">
						<hlm-option [value]="null"
							>{{ 'misc.none' | translate }}</hlm-option
						>
						@for (option of parent.data!.items; track option.id) {
						<hlm-option [value]="option.value">{{ option.label }}</hlm-option>
						}
					</hlm-select-content>
				</hlm-select>
				<ng-container
					[ngTemplateOutletContext]="{ $implicit: fg.controls.parentValue }"
					[ngTemplateOutlet]="errorsTemplate"
				/>
			</div>
		</div>
		}
		<div class="flex items-center justify-center self-end">
			<button
				class="group-hover/item:pointer-events-auto group-hover/item:opacity-100 pointer-events-none opacity-0"
				type="button"
				size="icon-sm"
				hlmBtn
				(click)="onDeleteDatasetItemButtonClicked(line, index)"
				variant="outline"
			>
				<ng-icon name="lucideTrash2" />
			</button>
		</div>
	</ng-container>
</ng-template>

<ng-template #errorsTemplate let-field>
	@if (field.pending) {
	<div class="flex items-baseline gap-1" hlmFieldDescription>
		<hlm-spinner />
		<span class="capitalize">{{ 'misc.checking' | translate }}...</span>
	</div>
	} @else if (field.invalid) {
	<div
		animate.enter="opacity-100"
		animate.leave="opacity-0"
		class="space-y-1 transition-[colors,opacity]"
	>
		<ng-container> @let errors = field.errors | values; </ng-container>
		@for (error of errors; track error) {
		<span class="text-red-500 text-sm block">
			{{ $any(error).message | translate }}
		</span>
		}
	</div>
	}
</ng-template>
